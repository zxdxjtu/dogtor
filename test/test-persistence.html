<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢ˆæ¤æ²»ç–—åŠ©æ‰‹ - çŠ¶æ€æŒä¹…åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background: #0056CC;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .clear-btn {
            background: #FF3B30;
        }
        
        .clear-btn:hover {
            background: #D70015;
        }
        
        .status {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .status h3 {
            margin: 0 0 12px 0;
            color: #495057;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
        }
        
        .status-label {
            font-weight: 500;
            color: #6c757d;
        }
        
        .status-value {
            color: #212529;
            font-family: monospace;
        }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .success {
            color: #28a745;
        }
        
        .error {
            color: #dc3545;
        }
        
        .warning {
            color: #ffc107;
        }
        
        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é¢ˆæ¤æ²»ç–—åŠ©æ‰‹ - çŠ¶æ€æŒä¹…åŒ–æµ‹è¯•</h1>
        
        <div class="test-controls">
            <button id="runTestsBtn">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button id="getStateBtn">è·å–å½“å‰çŠ¶æ€</button>
            <button id="clearStorageBtn" class="clear-btn">æ¸…é™¤å­˜å‚¨</button>
        </div>
        
        <div class="status" id="statusSection">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div class="status-item">
                <span class="status-label">æ‰©å±•çŠ¶æ€:</span>
                <span class="status-value" id="extensionStatus">æœªçŸ¥</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ˜¯å¦å¯ç”¨:</span>
                <span class="status-value" id="isEnabled">æœªçŸ¥</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ˜¯å¦æ´»åŠ¨:</span>
                <span class="status-value" id="isActive">æœªçŸ¥</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ—‹è½¬è§’åº¦:</span>
                <span class="status-value" id="rotationAngle">æœªçŸ¥</span>
            </div>
            <div class="status-item">
                <span class="status-label">å‘¨æœŸæ—¶é•¿:</span>
                <span class="status-value" id="cycleDuration">æœªçŸ¥</span>
            </div>
            <div class="status-item">
                <span class="status-label">ä¸‹æ¬¡æ—‹è½¬:</span>
                <span class="status-value" id="nextRotation">æœªçŸ¥</span>
            </div>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
        </div>
    </div>
    
    <script>
        // æ—¥å¿—è®°å½•
        const logContainer = document.getElementById('logContainer');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            logContainer.innerHTML = '';
        }
        
        // å‘é€æ¶ˆæ¯åˆ°æ‰©å±•
        function sendMessage(message) {
            return new Promise((resolve) => {
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    resolve({ success: false, error: 'æ‰©å±•ç¯å¢ƒä¸å¯ç”¨' });
                    return;
                }
                
                chrome.runtime.sendMessage(message, (response) => {
                    if (chrome.runtime.lastError) {
                        resolve({ success: false, error: chrome.runtime.lastError.message });
                    } else {
                        resolve(response || { success: false, error: 'æ— å“åº”' });
                    }
                });
            });
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        async function updateStatus() {
            try {
                const response = await sendMessage({ type: 'get_state' });
                
                if (response.success) {
                    const { state, settings } = response;
                    
                    document.getElementById('extensionStatus').textContent = 'æ­£å¸¸';
                    document.getElementById('isEnabled').textContent = settings.isEnabled ? 'æ˜¯' : 'å¦';
                    document.getElementById('isActive').textContent = state.isActive ? 'æ˜¯' : 'å¦';
                    document.getElementById('rotationAngle').textContent = `${settings.rotationAngle}Â°`;
                    document.getElementById('cycleDuration').textContent = `${settings.cycleDuration / 60000}åˆ†é’Ÿ`;
                    
                    if (state.nextRotationTime) {
                        const nextTime = new Date(state.nextRotationTime);
                        document.getElementById('nextRotation').textContent = nextTime.toLocaleTimeString();
                    } else {
                        document.getElementById('nextRotation').textContent = 'æ— ';
                    }
                } else {
                    document.getElementById('extensionStatus').textContent = `é”™è¯¯: ${response.error}`;
                }
            } catch (error) {
                document.getElementById('extensionStatus').textContent = `å¼‚å¸¸: ${error.message}`;
            }
        }
        
        // è¿è¡Œæµ‹è¯•
        async function runTests() {
            clearLog();
            log('å¼€å§‹çŠ¶æ€æŒä¹…åŒ–æµ‹è¯•...', 'info');
            
            const testCases = [
                {
                    name: 'æµ‹è¯•é»˜è®¤è®¾ç½®åŠ è½½',
                    test: async () => {
                        log('æ¸…é™¤æ‰€æœ‰å­˜å‚¨...', 'info');
                        await chrome.storage.sync.clear();
                        await chrome.storage.local.clear();
                        
                        const response = await sendMessage({ type: 'get_state' });
                        log(`é»˜è®¤çŠ¶æ€: ${JSON.stringify(response, null, 2)}`, 'info');
                        
                        return response.success && !response.settings.isEnabled;
                    }
                },
                {
                    name: 'æµ‹è¯•è®¾ç½®ä¿å­˜',
                    test: async () => {
                        const testSettings = {
                            isEnabled: true,
                            rotationAngle: 20,
                            cycleDuration: 15 * 60 * 1000,
                            rotationDuration: 45 * 1000,
                            showIndicator: true
                        };
                        
                        log('ä¿å­˜æµ‹è¯•è®¾ç½®...', 'info');
                        const saveResponse = await sendMessage({
                            type: 'settings_changed',
                            payload: testSettings
                        });
                        
                        if (!saveResponse.success) {
                            log(`è®¾ç½®ä¿å­˜å¤±è´¥: ${saveResponse.error}`, 'error');
                            return false;
                        }
                        
                        const getResponse = await sendMessage({ type: 'get_state' });
                        log(`ä¿å­˜åçš„è®¾ç½®: ${JSON.stringify(getResponse.settings, null, 2)}`, 'info');
                        
                        return getResponse.success && 
                               getResponse.settings.isEnabled === testSettings.isEnabled &&
                               getResponse.settings.rotationAngle === testSettings.rotationAngle;
                    }
                },
                {
                    name: 'æµ‹è¯•å¯åŠ¨çŠ¶æ€æŒä¹…åŒ–',
                    test: async () => {
                        log('å¯åŠ¨æ—‹è½¬...', 'info');
                        const startResponse = await sendMessage({
                            type: 'start_rotation',
                            payload: {
                                settings: {
                                    isEnabled: true,
                                    rotationAngle: 15,
                                    cycleDuration: 10 * 60 * 1000,
                                    rotationDuration: 30 * 1000,
                                    showIndicator: true
                                }
                            }
                        });
                        
                        if (!startResponse.success) {
                            log(`å¯åŠ¨å¤±è´¥: ${startResponse.error}`, 'error');
                            return false;
                        }
                        
                        const getResponse = await sendMessage({ type: 'get_state' });
                        log(`å¯åŠ¨åçš„çŠ¶æ€: ${JSON.stringify(getResponse, null, 2)}`, 'info');
                        
                        return getResponse.success && 
                               getResponse.settings.isEnabled === true &&
                               getResponse.state.isActive === true;
                    }
                },
                {
                    name: 'æµ‹è¯•åœæ­¢çŠ¶æ€æŒä¹…åŒ–',
                    test: async () => {
                        log('åœæ­¢æ—‹è½¬...', 'info');
                        const stopResponse = await sendMessage({ type: 'stop_rotation' });
                        
                        if (!stopResponse.success) {
                            log(`åœæ­¢å¤±è´¥: ${stopResponse.error}`, 'error');
                            return false;
                        }
                        
                        const getResponse = await sendMessage({ type: 'get_state' });
                        log(`åœæ­¢åçš„çŠ¶æ€: ${JSON.stringify(getResponse, null, 2)}`, 'info');
                        
                        return getResponse.success && 
                               getResponse.settings.isEnabled === false &&
                               getResponse.state.isActive === false;
                    }
                }
            ];
            
            let passedTests = 0;
            let totalTests = testCases.length;
            
            for (const testCase of testCases) {
                log(`\nè¿è¡Œæµ‹è¯•: ${testCase.name}`, 'info');
                
                try {
                    const result = await testCase.test();
                    
                    if (result) {
                        log(`âœ… ${testCase.name} - é€šè¿‡`, 'success');
                        passedTests++;
                    } else {
                        log(`âŒ ${testCase.name} - å¤±è´¥`, 'error');
                    }
                } catch (error) {
                    log(`âŒ ${testCase.name} - é”™è¯¯: ${error.message}`, 'error');
                }
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                await updateStatus();
                
                // æµ‹è¯•é—´éš”
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            log(`\næµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} é€šè¿‡`, 'info');
            
            if (passedTests === totalTests) {
                log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼çŠ¶æ€æŒä¹…åŒ–åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚', 'success');
            } else {
                log('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥çŠ¶æ€æŒä¹…åŒ–å®ç°ã€‚', 'warning');
            }
        }
        
        // æ¸…é™¤å­˜å‚¨
        async function clearStorage() {
            try {
                await chrome.storage.sync.clear();
                await chrome.storage.local.clear();
                log('å­˜å‚¨å·²æ¸…é™¤', 'info');
                await updateStatus();
            } catch (error) {
                log(`æ¸…é™¤å­˜å‚¨å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('runTestsBtn').addEventListener('click', runTests);
        document.getElementById('getStateBtn').addEventListener('click', updateStatus);
        document.getElementById('clearStorageBtn').addEventListener('click', clearStorage);
        
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus();
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>